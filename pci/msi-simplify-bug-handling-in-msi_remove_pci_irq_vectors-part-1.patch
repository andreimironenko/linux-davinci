From owner-linux-pci@atrey.karlin.mff.cuni.cz Thu Mar 22 03:53:40 2007
From: Michael Ellerman <michael@ellerman.id.au>
To: linux-pci@atrey.karlin.mff.cuni.cz
Cc: Greg Kroah-Hartman <greg@kroah.com>,
	Eric W.Biederman <ebiederm@xmission.com>,
	David S.Miller <davem@davemloft.net>,
	Benjamin Herrenschmidt <benh@kernel.crashing.org>,
	Andrew Morton <akpm@osdl.org>,
	<daniel.e.wolstenholme@intel.com>
Date: Thu, 22 Mar 2007 21:51:31 +1100
Subject: MSI: Simplify BUG() handling in msi_remove_pci_irq_vectors() part 1
Message-Id: <20070322105332.9F22BDDF52@ozlabs.org>

Although it might be nice to do a printk before BUG'ing, it's really not
necessary, and it complicates the code.

Signed-off-by: Michael Ellerman <michael@ellerman.id.au>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/pci/msi.c |    9 ++-------
 1 file changed, 2 insertions(+), 7 deletions(-)

--- a/drivers/pci/msi.c
+++ b/drivers/pci/msi.c
@@ -693,13 +693,8 @@ void msi_remove_pci_irq_vectors(struct p
  		return;
 
 	if (dev->msi_enabled) {
-		if (irq_has_action(dev->first_msi_irq)) {
-			printk(KERN_WARNING "PCI: %s: msi_remove_pci_irq_vectors() "
-			       "called without free_irq() on MSI irq %d\n",
-			       pci_name(dev), dev->first_msi_irq);
-			BUG_ON(irq_has_action(dev->first_msi_irq));
-		} else /* Release MSI irq assigned to this device */
-			msi_free_irq(dev, dev->first_msi_irq);
+		BUG_ON(irq_has_action(dev->first_msi_irq));
+		msi_free_irq(dev, dev->first_msi_irq);
 	}
 	if (dev->msix_enabled) {
 		int irq, head, tail = 0, warning = 0;
