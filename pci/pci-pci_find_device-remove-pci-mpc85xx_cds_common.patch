From akpm@osdl.org Sun Nov  6 23:40:08 2005
Message-Id: <200511070739.jA77dgWl023290@shell0.pdx.osdl.net>
Subject: PCI: pci_find_device remove (ppc/platforms/85xx/mpc85xx_cds_common.c)
To: greg@kroah.com
Cc: akpm@osdl.org, jirislaby@gmail.com, xslaby@fi.muni.cz
From: akpm@osdl.org
Date: Sun, 06 Nov 2005 23:39:35 -0800


From: Jiri Slaby <jirislaby@gmail.com>

Signed-off-by: Jiri Slaby <xslaby@fi.muni.cz>
Signed-off-by: Andrew Morton <akpm@osdl.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
---
 arch/ppc/platforms/85xx/mpc85xx_cds_common.c |   11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

--- gregkh-2.6.orig/arch/ppc/platforms/85xx/mpc85xx_cds_common.c
+++ gregkh-2.6/arch/ppc/platforms/85xx/mpc85xx_cds_common.c
@@ -350,10 +350,10 @@ mpc85xx_cds_fixup_via(struct pci_control
 void __init
 mpc85xx_cds_pcibios_fixup(void)
 {
-        struct pci_dev *dev = NULL;
+        struct pci_dev *dev;
 	u_char		c;
 
-        if ((dev = pci_find_device(PCI_VENDOR_ID_VIA,
+	if ((dev = pci_get_device(PCI_VENDOR_ID_VIA,
                                         PCI_DEVICE_ID_VIA_82C586_1, NULL))) {
                 /*
                  * U-Boot does not set the enable bits
@@ -370,21 +370,24 @@ mpc85xx_cds_pcibios_fixup(void)
 		 */
                 dev->irq = 14;
                 pci_write_config_byte(dev, PCI_INTERRUPT_LINE, dev->irq);
+		pci_dev_put(dev);
         }
 
 	/*
 	 * Force legacy USB interrupt routing
 	 */
-        if ((dev = pci_find_device(PCI_VENDOR_ID_VIA,
+	if ((dev = pci_get_device(PCI_VENDOR_ID_VIA,
                                         PCI_DEVICE_ID_VIA_82C586_2, NULL))) {
                 dev->irq = 10;
                 pci_write_config_byte(dev, PCI_INTERRUPT_LINE, 10);
+		pci_dev_put(dev);
         }
 
-        if ((dev = pci_find_device(PCI_VENDOR_ID_VIA,
+	if ((dev = pci_get_device(PCI_VENDOR_ID_VIA,
                                         PCI_DEVICE_ID_VIA_82C586_2, dev))) {
                 dev->irq = 11;
                 pci_write_config_byte(dev, PCI_INTERRUPT_LINE, 11);
+		pci_dev_put(dev);
         }
 }
 #endif /* CONFIG_PCI */
